---
title: "Figures for the paper"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{paper_mortality}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}

library(brazildatamortality)
library(dplyr)
library(ggplot2)
library(patchwork)
library(kableExtra)

data_tb <- get_data()

```



```{r data, include=FALSE}
# Deaths by hydro-geological events and extreme temperatures.
hydrogeo_extemp_tb <- data_tb %>% 
  dplyr::filter(!(cause %in% c("Lightning",
                               "Sunlight",
                               "Volcano",
                               "Other"))) %>%
    dplyr::filter(!(death_city %in% c("310900", "314000")))


# NOTE: Brumadinho & Mariana are excluded!
hydrogeo_extemp_light_tb <- 
    data_tb %>% 
    dplyr::filter(!(cause %in% c("Sunlight",
                                 "Volcano",
                                 "Other"))) %>%
    dplyr::filter(!(death_city %in% c("310900", "314000")))

```



## Logaritimic number of deaths by heat, cold, ligthning, storms and earth movement events

```{r fig_log, echo=FALSE, fig.width = 10, fig.height = 7}

plot_tb <-
    hydrogeo_extemp_light_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Lightning"                           = "Lightning",
        "Earth surface movement and Eruption" = "Landslide",
        "Heat"                                = "Heat",
        "Cataclismyc and Floods"              = "Storm",
        "Cold"                                = "Cold",
        "Landslide"                           = "Landslide",
        "Cataclismyc"                         = "Storm",                       
        "Flood"                               = "Storm",
        "Earthquake"                          = "Landslide"
    )) %>%
    dplyr::group_by(death_year, cause) %>%
    dplyr::summarize(fatalities = dplyr::n(),
                     .groups = "drop") %>%
    # NOTE: Util function for adding the roll means as a new column.
    (function(x) {
        my_data <- x %>%
            dplyr::arrange(death_year, cause) %>%
            tidyr::pivot_wider(id_cols = death_year,
                               names_from = cause,
                               values_from = fatalities)
        my_roll <- RcppRoll::roll_mean(as.matrix(dplyr::select(my_data, 
                                                               -death_year)),
                                       n = 5,
                                       align = "right",
                                       fill = NA,
                                       na.rm = TRUE) %>%
            tibble::as_tibble() %>%
            magrittr::set_names(paste(names(.), "roll_mean", sep = "_")) %>%
            dplyr::mutate(death_year = my_data$death_year) %>%
            tidyr::pivot_longer(!death_year) %>%
            dplyr::rename(moving_average = value)
        my_data %>%
            tidyr::pivot_longer(!death_year,
                                names_to = "cause",
                                values_to = "fatalities") %>%
            dplyr::bind_cols(dplyr::select(my_roll, moving_average)) %>%
            return()
    }) 

mean_tb <-
    plot_tb %>%
    dplyr::group_by(cause) %>%
    dplyr::summarize(my_mean = mean(fatalities, na.rm = TRUE))

fig_03 <-
    plot_tb %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities)) +
    ggplot2::geom_line(ggplot2::aes(x = death_year,
                                    y = moving_average,
                                    group = cause,
                                    color = cause)) +
    ggplot2::scale_y_log10() +
    ggplot2::xlab("Year") +
    ggplot2::theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::labs(color = "Fatality cause") +
    #ggplot2::ggtitle("Moving average (5 years) of fatalities")  + 
    ggplot2::theme_bw() +
    ggplot2::geom_hline(ggplot2::aes(yintercept = my_mean,
                                     group = cause,
                                     color = cause), 
                        mean_tb, 
                        linetype = "dotted",
                        size = 0.5)

# TODO: Where are we saying this is a five-year mean?
fig_03

ggplot2::ggsave(plot = fig_03,
                filename = "~/Desktop/fig_03.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_03)
rm(mean_tb)
rm(plot_tb)

```



## Cumulative number of fatalities due to lightning, hydro-geo and extreme temperature events and total sum
## Points and lines

```{r fig_cum, echo=FALSE, fig.width = 10, fig.height = 7}

fig_04 <- 
    hydrogeo_extemp_light_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Lightning"                           = "Lightning",
        "Earth surface movement and Eruption" = "Landslide",
        "Heat"                                = "Heat",
        "Cataclismyc and Floods"              = "Storm",
        "Cold"                                = "Cold",
        "Landslide"                           = "Landslide",
        "Cataclismyc"                         = "Storm",                       
        "Flood"                               = "Storm",
        "Earthquake"                          = "Landslide"
    )) %>%
    dplyr::group_by(death_year, cause) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>% 
    (function(x) {
        total_year <- x %>%
            dplyr::group_by(death_year) %>%
            dplyr::summarize(fatalities = sum(fatalities),
                             .groups = "drop") %>%
            dplyr::mutate(cause = "Total by year") %>%
            dplyr::select(death_year, cause, fatalities)
        x %>% 
            dplyr::bind_rows(total_year) %>%
            dplyr::arrange(death_year, cause) %>% 
            return()
    }) %>%
    dplyr::group_by(cause) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities") +
    ggplot2::labs(color = "Fatality cause") +
    #ggplot2::ggtitle("Cumulative number of fatalities by cause from 1979 to 2019") +
    ggplot2::scale_color_brewer(palette = "Dark2") +
    ggplot2::theme_bw()

# TODO: Are the points on top of the lines needed?
fig_04

ggplot2::ggsave(plot = fig_04,
                filename = "~/Desktop/fig_04.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_04)

```



## Deaths due to lightning, storms, earth movement, cold and heat events 
## Graphic points and lines

```{r plot_causes, echo=FALSE, fig.width = 7, fig.height = 5}

fig_05 <- 
    hydrogeo_extemp_light_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Lightning"                           = "Lightning",
        "Earth surface movement and Eruption" = "Landslide",
        "Heat"                                = "Heat",
        "Cataclismyc and Floods"              = "Storm",
        "Cold"                                = "Cold",
        "Landslide"                           = "Landslide",
        "Cataclismyc"                         = "Storm",                       
        "Flood"                               = "Storm",
        "Earthquake"                          = "Landslide"
    )) %>%
    dplyr::group_by(cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::arrange(cause, death_year) %>%
    dplyr::filter(cause %in% c("Lightning",
                               "Landslide",
                               "Heat",
                               "Storm",
                               "Cold",
                               "Landslide")) %>%             
    dplyr::filter(!is.na(cause), !is.na(death_year)) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::labs(color = "Fatality cause") +
    #ggplot2::ggtitle("Death due to forces of nature") + 
    ggplot2::scale_color_brewer(palette = "Dark2") +
    ggplot2::theme_bw()

fig_05

ggplot2::ggsave(plot = fig_05,
                filename = "~/Desktop/fig_05.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_5)

```



## Map by state

```{r map_state_cum, echo=FALSE, fig.width = 10, fig.height = 7}

state_tb <- 
    brazildatamortality::state_sf %>% 
    sf::st_set_geometry(NULL) %>% 
    dplyr::mutate(code_state = as.character(code_state))


# 3 maps_one category by map

state_data <- 
    hydrogeo_extemp_light_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Lightning"                           = "Lightning",
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::mutate(code_state = stringr::str_sub(death_city, 1, 2)) %>% 
    dplyr::left_join(state_tb, by = "code_state") %>% 
    dplyr::group_by(abbrev_state, cause) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::ungroup()

state_hex <- brazildatamortality::state_hex
 
plot_sf <- merge(state_hex, state_data,
                 by = "abbrev_state",
                 all.x = TRUE)

fig_09 <- 
    plot_sf %>%
    ggplot2::ggplot() +
    ggplot2::geom_sf(data = state_hex) +
    ggplot2::geom_sf(ggplot2::aes(fill = fatalities)) +
    ggplot2::geom_sf_text(data = state_hex,
                          size = 2,
                          ggplot2::aes(label = abbrev_state)) +
    ggplot2::facet_wrap(~cause) +
    ggplot2::theme_bw() +
    ggplot2::theme(axis.text.x = element_blank(),
                   axis.text.y = element_blank(),
                   axis.ticks.x = element_blank(),
                   axis.ticks.y = element_blank(),
                   axis.title.x = element_blank(),
                   axis.title.y = element_blank() ) +
    ggplot2::scale_fill_gradient(name = "Fatalities", 
                                 trans = "log",
                                 breaks = c(1, 5, 50, 500),
                                 low = "green",
                                 high = "red") 

fig_09

ggplot2::ggsave(plot = fig_09,
                filename = "~/Desktop/fig_09.jpg",
                width = 148.5, 
                height = 52.5,
                units = "mm")
rm(fig_09)

```



## Cumulative n. fatalities by season
## Bars

```{r fig_season_cum_year, echo=FALSE, fig.width = 10, fig.height = 7}

year_span <- 
    hydrogeo_extemp_light_tb %>% 
    dplyr::pull(death_date) %>%
    lubridate::year() %>%
    range()
year_span <- year_span + c(-1, 1)
year_span <- year_span[1]:year_span[2]

season_start <- c("Jan-Mar" = "12-21",
                  "Apr-Jun" = "03-20",
                  "Jul-Sep" = "06-21",
                  "Oct-Dec" = "09-22")

season_vec <- year_span %>% 
  tidyr::expand_grid(season_start) %>%
  dplyr::mutate(season_start = paste(year_span, season_start, sep = "-")) %>% 
  dplyr::mutate(season_start = lubridate::as_date(season_start)) %>%
  arrange(season_start) %>%
  pull(season_start) %>%
  sort()

find_season <- function(x){
  return(season_vec[findInterval(x, season_vec)])
}

get_season <- function(x) {
  return(paste(sprintf("%02d", lubridate::month(x)),
               sprintf("%02d", lubridate::day(x)),
               sep = "-"))
}

get_season_name <- function(x) {
  return(names(which(x == season_start)))
}

fig_07 <- 
    hydrogeo_extemp_light_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Lightning"                           = "Lightning",
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological", 
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::mutate(death_season = purrr::map(death_date, 
                                            find_season),
                  death_season = purrr::map_chr(death_season,
                                                get_season),
                  death_season = purrr::map_chr(death_season, 
                                                get_season_name)) %>%
    dplyr::mutate(death_season = factor(
        death_season,
        ordered = TRUE,
        levels = names(season_start),
        )
    ) %>%
    ggplot2::ggplot() + 
    ggplot2::geom_bar(ggplot2::aes(x = death_season, 
                                   fill = cause)) +
    ggplot2::scale_fill_brewer(palette = "Dark2") + 
    ggplot2::xlab("Season of death") +
    ggplot2::ylab("Number of deaths") +
    ggplot2::labs(fill = "Fatality cause") +
    #ggplot2::ggtitle("Number of deaths by season and cause") +
    ggplot2::theme_bw()

fig_07

ggplot2::ggsave(plot = fig_07,
                filename = "~/Desktop/fig_07.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_07)

```


## Number of deaths by month by categories
## Bars

```{r month, echo=FALSE, fig.width = 10, fig.height = 7}

fig_06 <-
    hydrogeo_extemp_light_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Lightning"                           = "Lightning",
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::select(cause, death_month) %>%
    tidyr::drop_na() %>%
    dplyr::mutate(death_month = month.abb[death_month],
                  death_month = factor(death_month,
                                       ordered = TRUE,
                                       levels = c(month.abb))) %>% 
    dplyr::mutate_all(as.factor) %>%
    ggplot2::ggplot() +
    ggplot2::geom_bar(ggplot2::aes(x = death_month,
                                   fill = cause)) +
    ggplot2::scale_fill_brewer(palette = "Dark2") +      
    ggplot2::xlab("Month") +
    ggplot2::ylab("Cumulative number of fatalities") +
    ggplot2::labs(fill = "Fatality cause") +
    #ggplot2::ggtitle("Deaths by cause by month") + 
    ggplot2::theme_bw()

fig_06

ggplot2::ggsave(plot = fig_06,
                filename = "~/Desktop/fig_06.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_06)

```



## SOCIAL ANALYSIS WITHOUT LIGHTNING

## PIRAMIDE ETÁRIA
## Number total by sex by age

```{r death_by_sex_age, echo=FALSE, fig.width = 10, fig.height = 7}

age_start <- seq(0, 90, by = 5) 
age_start[length(age_start)] <- Inf
names(age_start) <- paste(age_start, c(age_start[-1], ""), sep = "-")
age_start <- age_start[1:(length(age_start) - 1)]

get_age_interval <- function(x, age_start) {
  return(findInterval(x, age_start))
}

age_start_label <- paste(age_start, c((age_start - 1)[-1], ""), sep = "-")

plot_tb <- 
    hydrogeo_extemp_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::filter(sex %in% c("Female", "Male")) %>% 
    dplyr::mutate(death_age_interval = purrr::map_dbl(age,
                                                      get_age_interval,
                                                      age_start = age_start)) %>%
    tidyr::drop_na(death_age_interval) %>%
    dplyr::group_by(sex, death_age_interval) %>%
    dplyr::summarise(fatalities = dplyr::n()) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(death_age_interval = dplyr::recode(death_age_interval,
                                                     !!!age_start_label),
                  death_age_interval = factor(death_age_interval,
                                              ordered = TRUE,
                                              levels = age_start_label))

plot_tb <-
    plot_tb %>%
    tidyr::pivot_wider(names_from = sex, values_from = fatalities) %>%
    dplyr::mutate(
        Female_pc = round(100 * Female / (Female + Male), digits = 1),
        Male_pc = round(  100 * Male   / (Female + Male), digits = 1)
    ) %>%
    dplyr::select(death_age_interval, Female = Female_pc, Male = Male_pc) %>%
    tidyr::pivot_longer(cols = c(Female, Male), 
                        names_to = "sex", values_to = "percentage") %>%
    dplyr::right_join(y = plot_tb, by = c("sex", "death_age_interval")) %>%
    dplyr::mutate(text_pos = dplyr::if_else(sex == "Female", 
                                            as.integer(fatalities * (-1)), 
                                            as.integer(fatalities)))

fig_10 <- 
    ggplot2::ggplot(plot_tb,
                ggplot2::aes(x = death_age_interval,
                             fill = sex)) +
    ggplot2::geom_bar(data = dplyr::filter(plot_tb, sex == "Male"),
                      mapping = ggplot2::aes(y = fatalities),
                      stat = "identity") +
    ggplot2::geom_bar(data = dplyr::filter(plot_tb, sex == "Female"),
                      mapping = ggplot2::aes(y = fatalities * (-1)),
                      stat = "identity") +
    ggplot2::coord_flip() +
    ggplot2::scale_fill_brewer(palette = "Pastel2") +    
    ggplot2::scale_y_continuous(labels = abs) +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::xlab("Age group") +
    ggplot2::labs(fill = "Sex") +
    ggplot2::theme_bw() +
    ggplot2::geom_text(
        ggplot2::aes(label = paste0(percentage, "%"), 
                     y = text_pos), 
        nudge_y = -.01,
        size = 2
    )

fig_10

ggplot2::ggsave(plot = fig_10,
                filename = "~/Desktop/fig_10.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_10)

```


## Total number by category

```{r death_by_sex_age_cause, echo=FALSE, fig.width = 10, fig.height = 7}

age_start <- seq(0, 90, by = 5) 
age_start[length(age_start)] <- Inf
names(age_start) <- paste(age_start, c(age_start[-1], ""), sep = "-")
age_start <- age_start[1:(length(age_start) - 1)]

get_age_interval <- function(x) {
  return(findInterval(x, age_start))
}

age_start_label <- paste(age_start, c((age_start - 1)[-1], ""), sep = "-")

plot_tb <- 
    hydrogeo_extemp_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::filter(sex %in% c("Female", "Male")) %>% 
    dplyr::mutate(death_age_interval = purrr::map_dbl(age,
                                                      get_age_interval)) %>%
    tidyr::drop_na(death_age_interval) %>%
    dplyr::group_by(cause, sex, death_age_interval) %>%
    dplyr::summarise(fatalities = dplyr::n()) %>%
    dplyr::ungroup() %>% 
    dplyr::mutate(death_age_interval = dplyr::recode(death_age_interval,
                                                     !!!age_start_label),
                  death_age_interval = factor(death_age_interval,
                                              ordered = TRUE,
                                              levels = age_start_label)) 

plot_tb %>%
    tidyr::pivot_wider(names_from = c(sex, cause), values_from = fatalities) %>%
    dplyr::arrange(death_age_interval) %>%
    kableExtra::kable()

fig_11 <-
    ggplot2::ggplot(plot_tb,
                    ggplot2::aes(x = death_age_interval)) +
    ggplot2::geom_bar(data = dplyr::filter(plot_tb, sex == "Male"),
                      mapping = ggplot2::aes(y = fatalities, 
                                             fill = cause),
                      stat = "identity") +
    ggplot2::geom_bar(data = dplyr::filter(plot_tb, sex == "Female"),
                      mapping = ggplot2::aes(y = fatalities * (-1), 
                                             fill = cause),
                      stat = "identity") +
    ggplot2::coord_flip() +
    ggplot2::scale_fill_brewer(palette = "Accent") +  
    ggplot2::geom_hline(yintercept = 0, 
                        linetype = "dashed", 
                        color = "black") +
    ggplot2::scale_y_continuous(labels = abs) +
    ggplot2::ylab("Number of fatalities (women to the left, men to the right)") +
    ggplot2::xlab("Age group") +
    ggplot2::labs(fill = "Fatality cause") +
    ggplot2::theme_bw()

fig_11

ggplot2::ggsave(plot = fig_11, 
                filename = "~/Desktop/fig_11.jpg",
                width = 148.5, 
                height = 105,
                units = "mm")
rm(fig_11)

```



## LOCUS
## SEX, AGE, LOCUS
## GEOM_BAR GRAPHS

```{r death_by_sex_age_locus, echo=FALSE, fig.width = 10, fig.height = 7}

age_start <- seq(0, 90, by = 5) 
age_start[length(age_start)] <- Inf
names(age_start) <- paste(age_start, c(age_start[-1], ""), sep = "-")
age_start <- age_start[1:(length(age_start) - 1)]

get_age_interval <- function(x) {
    return(findInterval(x, age_start))
}

my_interval <- tibble::tibble(id = age_start,
                              label = names(age_start))

age_start_label <- paste(age_start, c((age_start - 1)[-1], ""), sep = "-")

# ONLY FOR HYDROGEOLOGICAL

plot_tb <- 
    hydrogeo_extemp_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                           = "Hydrogeological"
    )) %>%
    dplyr::filter(cause %in% "Hydrogeological") %>%
    dplyr::mutate(locus = dplyr::recode(
        locus,
        "Healh Stablishment"    = "Hospital",
        "Home"                  = "Home",
        "Hospital"              = "Hospital",
        "Ignored"               = "Ignored",
        "No information"        = "Ignored",
        "Other"                 = "Other",
        "Public place"          = "Public place",
        "Street"                = "Public place"
    )) %>%
    dplyr::filter(sex %in% c("Female", "Male")) %>%
    dplyr::mutate(death_age_interval = purrr::map_int(age,
                                                      get_age_interval)) %>%
    tidyr::drop_na(death_age_interval) %>%
    dplyr::group_by(cause, sex, death_age_interval, locus) %>%
    dplyr::group_by(cause, sex, death_age_interval, locus) %>%
    dplyr::summarise(fatalities = dplyr::n()) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(death_age_interval) %>%
    dplyr::mutate(death_age_interval = dplyr::recode(death_age_interval,
                                                     !!!age_start_label),
                  death_age_interval = factor(death_age_interval,
                                              ordered = TRUE,
                                              levels = age_start_label))

plot_tb %>%
    tidyr::pivot_wider(names_from = c(cause, sex, locus), 
                       values_from = fatalities) %>%
    kableExtra::kable()

fig_12_hydrogeo <- 
    plot_tb %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = sex, 
                                 y = fatalities, 
                                 fill = locus)) + 
    ggplot2::geom_bar(stat = 'identity') +
    ggplot2::scale_fill_brewer(palette = "Spectral") +
    ggplot2::facet_grid(rows = vars(cause),
                        cols = vars(death_age_interval)) +
    ggplot2::theme(axis.text.x = element_text(angle = 270, hjust = 1)) +
    #ggplot2::ggtitle("Hydrogeological") +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 270,
                                                       vjust = 0.5, 
                                                       hjust = 1),
                   panel.background = ggplot2::element_blank()) +
    ggplot2::xlab("Sex") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::labs(fill = "Fatality locus")

fig_12_hydrogeo

ggplot2::ggsave(plot = fig_12_hydrogeo,
                filename = "~/Desktop/fig_12_hydrogeo.jpg",
                width = 297, 
                height = 105,
                units = "mm")

rm(fig_12_hydrogeo)



## ONLY FOR EXTREME TEMPERATURE

plot_tb <- 
    hydrogeo_extemp_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                           = "Hydrogeological"
    )) %>%
    dplyr::filter(cause %in% "Extreme temperature") %>%
    dplyr::mutate(locus = dplyr::recode(
        locus,
        "Healh Stablishment"    = "Hospital",
        "Home"                  = "Home",
        "Hospital"              = "Hospital",
        "Ignored"               = "Ignored",
        "No information"        = "Ignored",
        "Other"                 = "Other",
        "Public place"          = "Public place",
        "Street"                = "Public place"
    )) %>%
    dplyr::filter(sex %in% c("Female", "Male")) %>%
    dplyr::mutate(death_age_interval = purrr::map_int(age,
                                                      get_age_interval)) %>%
    tidyr::drop_na(death_age_interval) %>%
    dplyr::group_by(cause, sex, death_age_interval, locus) %>%
    dplyr::group_by(cause, sex, death_age_interval, locus) %>%
    dplyr::summarise(fatalities = dplyr::n()) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(death_age_interval) %>%
    dplyr::mutate(death_age_interval = dplyr::recode(death_age_interval,
                                                     !!!age_start_label),
                  death_age_interval = factor(death_age_interval,
                                              ordered = TRUE,
                                              levels = age_start_label))

plot_tb %>%
    tidyr::pivot_wider(names_from = c(cause, sex, locus), 
                       values_from = fatalities) %>%
    kableExtra::kable()

fig_12_ext <-
    plot_tb %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = sex, 
                                 y = fatalities, 
                                 fill = locus)) + 
    ggplot2::geom_bar(stat = 'identity') +
    ggplot2::scale_fill_brewer(palette = "Spectral") +
    ggplot2::facet_grid(rows = vars(cause),
                        cols = vars(death_age_interval)) +
    ggplot2::theme(axis.text.x = element_text(angle = 270, hjust = 1)) +
    #ggplot2::ggtitle("Extreme temperature") +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 270,
                                                       vjust = 0.5, 
                                                       hjust = 1),
                   panel.background = ggplot2::element_blank()) +
    ggplot2::xlab("Sex") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::labs(fill = "Fatality locus")

fig_12_ext

ggplot2::ggsave(plot = fig_12_ext,
                filename = "~/Desktop/fig_12_ext.jpg",
                width = 297, 
                height = 105,
                units = "mm")

rm(fig_12_ext)

```



## MARITAL
## SEX, AGE, MARITAL
## GEOM_BAR GRAPH

```{r death_by_sex_age_marital, echo=FALSE, fig.width = 10, fig.height = 7}

age_start <- seq(15, 90, by = 5)
age_start[length(age_start)] <- Inf
names(age_start) <- paste(age_start, c(age_start[-1], ""), sep = "-")
age_start <- age_start[1:(length(age_start) - 1)]

get_age_interval <- function(x) {
    return(findInterval(x, age_start))
}

my_interval <- tibble::tibble(id = age_start,
                              label = names(age_start))

age_start_label <- paste(age_start, c((age_start - 1)[-1], ""), sep = "-")



## MARITAL ONLY FOR HYDROGEOLOGICAL

plot_tb <- 
    hydrogeo_extemp_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological", 
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::filter(cause == "Hydrogeological",
                  sex %in% c("Female", "Male")) %>%
    tidyr::drop_na(marital) %>%
    dplyr::mutate(marital = dplyr::recode(marital, 
                                          "No information" = "Ignored"), 
                  death_age_interval = purrr::map_int(age,
                                                      get_age_interval)) %>%
    tidyr::drop_na(death_age_interval) %>%
    dplyr::group_by(cause, sex, death_age_interval, marital) %>%
    dplyr::summarise(fatalities = dplyr::n()) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(death_age_interval) %>%
    # TODO: People dying under 15 years old are ignored!
    dplyr::mutate(death_age_interval = dplyr::recode(death_age_interval,
                                                     !!!age_start_label,
                                                     .default = NA_character_
                                                     ),
                  death_age_interval = factor(death_age_interval,
                                              ordered = TRUE,
                                              levels = age_start_label)) %>%
    tidyr::drop_na(death_age_interval)

plot_tb %>%
    tidyr::pivot_wider(names_from = c(cause, sex, marital),
                       values_from = fatalities) %>%
    kableExtra::kable()

fig_14_hydrogeo <- 
    plot_tb %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = sex,
                                 y = fatalities,
                                 fill = marital)) +
    ggplot2::geom_bar(stat = 'identity') +
    ggplot2::scale_fill_brewer(palette = "BrBG") +
    ggplot2::facet_grid(rows = vars(cause),
                        cols = vars(death_age_interval)) +
    ggplot2::theme(axis.text.x = element_text(angle = 270, hjust = 1)) +
    #ggplot2::ggtitle("Hydrogeological") +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 270,
                                                          vjust = 0.5,
                                                          hjust = 1),
                   panel.background = ggplot2::element_blank()) +
    ggplot2::xlab("Sex") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::labs(fill = "Marital status")

fig_14_hydrogeo

ggplot2::ggsave(plot = fig_14_hydrogeo,
                filename = "~/Desktop/fig_14_hydrogeo.jpg",
                width = 297, 
                height = 105,
                units = "mm")

rm(fig_14_hydrogeo)



## ONLY FOR EXTREME TEMPERATURE

plot_tb <- 
    hydrogeo_extemp_tb %>%
    dplyr::mutate(cause = dplyr::recode(
        cause,
        "Earth surface movement and Eruption" = "Hydrogeological",
        "Heat"                                = "Extreme temperature",
        "Cataclismyc and Floods"              = "Hydrogeological",
        "Cold"                                = "Extreme temperature",
        "Landslide"                           = "Hydrogeological",
        "Cataclismyc"                         = "Hydrogeological",
        "Flood"                               = "Hydrogeological",
        "Earthquake"                          = "Hydrogeological"
    )) %>%
    dplyr::filter(cause == "Extreme temperature",
                  marital != "Other",
                  sex %in% c("Female", "Male")) %>%
    tidyr::drop_na(marital) %>%
    dplyr::mutate(marital = dplyr::recode(marital, 
                                          "No information" = "Ignored"),
                  death_age_interval = purrr::map_int(age,
                                                      get_age_interval))  %>%
    tidyr::drop_na(death_age_interval) %>%
    dplyr::group_by(cause, sex, death_age_interval, marital) %>%
    dplyr::summarise(fatalities = dplyr::n()) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(death_age_interval) %>%
    dplyr::mutate(death_age_interval = dplyr::recode(death_age_interval,
                                                     !!!age_start_label, 
                                                     .default = NA_character_),
                  death_age_interval = factor(death_age_interval,
                                              ordered = TRUE,
                                              levels = age_start_label)) %>%
    tidyr::drop_na(death_age_interval)

plot_tb %>%
    tidyr::pivot_wider(names_from = c(cause, sex, marital),
                       values_from = fatalities) %>%
    kableExtra::kable()

fig_14_ext <- 
    plot_tb %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = sex,
                                 y = fatalities,
                                 fill = marital)) +
    ggplot2::geom_bar(stat = 'identity') +
    ggplot2::scale_fill_brewer(palette = "BrBG") +
    ggplot2::facet_grid(rows = vars(cause),
                        cols = vars(death_age_interval)) +
    ggplot2::theme(axis.text.x = element_text(angle = 270, hjust = 1)) +
    #ggplot2::ggtitle("Extemp") +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 270,
                                                          vjust = 0.5,
                                                          hjust = 1),
                   panel.background = ggplot2::element_blank()) +
    ggplot2::xlab("Sex") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::labs(fill = "Marital status")

fig_14_ext

ggplot2::ggsave(plot = fig_14_ext,
                filename = "~/Desktop/fig_14_ext.jpg",
                width = 297, 
                height = 105,
                units = "mm")

# TODO: What are those ignored? How are different from 'No information'?

```

