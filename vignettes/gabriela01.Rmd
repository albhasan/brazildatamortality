---
title: "Exploratory data analysis"
subtitle: "Without no catastrophical natural hazards"  
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{gabriela01}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
    chunk_output_type: console
---
    
```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r setup, include = FALSE}

library(dplyr)
library(ggplot2)
library(knitr)
library(skimr)
library(stringr)
library(tidyr)

library(brazildatamortality)


```


```{r check_variables, include=FALSE}

# Check that data before and after 1996 have the same variables and categories.

data_9  <- brazildatamortality::data_icd_9
data_10 <- brazildatamortality::data_icd_10

```



```{r merge_filter_both_data, include=FALSE}

data_10 <- data_10 %>% 
    dplyr::select(birth_date, cause, death_city, death_date, education, 
                  job, locus, marital, residence_city, sex, color_race, 
                  literacy)
data_9  <- data_9  %>% 
    dplyr::select(birth_date, cause, death_city, death_date, education, 
                  job, locus, marital, residence_city, sex) %>% 
    dplyr::mutate(color_race = NA,
                  literacy = NA)


# DATA: ALL FORCES OF NATURE INCLUDED IN THE "SIM" SYSTEM 
all_data <- data_9 %>%
    dplyr::bind_rows(data_10) %>%
    dplyr::mutate(death_year = lubridate::year(death_date),
#                  computed_age = difftime(death_date, birth_date, 
#                                          units = "days"),
                  death_month = lubridate::month(death_date)) %>%
    tidyr::drop_na(cause, death_date)


# DATA: HYDRO-GEOLOGICAL AND EXTREME TEMPERATURES DISASTERS' FILTERED SIM SYSTEM 
hydrogeo_extemp_tb <- data_9 %>%
    dplyr::bind_rows(data_10) %>%
    dplyr::mutate(death_year = lubridate::year(death_date),
#                  computed_age = difftime(death_date, birth_date, 
#                                          units = "days"),
                  death_month = lubridate::month(death_date)) %>%
    tidyr::drop_na(cause, death_date) %>%
    dplyr::filter(!(cause %in% c("Lightning",
                                 "Sunlight",
                                 "Volcano",
                                 "Other")))


# DATA: JUST FOR 2011 TRAGEDY
serrana_tb <- hydrogeo_extemp_tb %>%
    dplyr::filter(death_date > as.Date("2011-01-10"),
                  death_date < as.Date("2011-01-13"))


# DATA: WITHOUT 2011 TRAGEDY
hydrogeo_extemp_no_serrana_tb <- hydrogeo_extemp_tb %>%
    dplyr::filter(death_date < as.Date("2011-01-11") | 
                      death_date > as.Date("2011-01-12"))

```



```{r plot_causes_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

# TOTAL N. OF DEATHS DUE TO ALL FORCES OF NATURE
all_data %>%
    dplyr::group_by(cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(cause, death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities") +
    ggplot2::ggtitle("Cumulative sum of deaths by forces of nature") +
    ggplot2::scale_color_brewer(palette = "Paired")


# TOTAL N. OF DEATHS DUE TO HYDRO-GEO AND EXT TEMP CAUSES
hydrogeo_extemp_tb %>%
    dplyr::group_by(cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(cause, death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities") +
    ggplot2::ggtitle("Cumulative sum of deaths by hydro-geological and extreme temperature events") +
    ggplot2::scale_color_brewer(palette = "Paired")

```



```{r plot_cumsum1, echo=FALSE, fig.width = 7, fig.height = 5}

# CUMULATIVE DEATHS BY HYDRO-GEO AND EXT TEMP CAUSES
# TODO: REVIEW TITTLE
hydrogeo_extemp_tb %>%
    dplyr::group_by(death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities") +
    ggplot2::ggtitle("Cumulative number of deaths due to hydro-geo and ext temp events")



# CUMULATIVE DEATHS BY HYDRO-GEO AND EXT TEMP CAUSES W/O 2011 TRAGEDY
# TODO: REVIEW TITTLE
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::group_by(death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities") +
    ggplot2::ggtitle("Cumulative number of deaths due to hydro-geo and ext temp events w/o 2011 tragedy")


```



```{r plot_total1, echo=FALSE, fig.width = 7, fig.height = 5}

# BY YEAR: HYDRO-GEO AND EXT TEMP CAUSES
# TODO: REVIEW TITTLE
hydrogeo_extemp_tb %>%
    dplyr::group_by(death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::mutate(moving_average = RcppRoll::roll_mean(fatalities, 
                                                       n = 5, 
                                                       align = "right", 
                                                       fill = NA,
                                                       na.rm = TRUE))  %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities)) +
    ggplot2::geom_point() +
    ggplot2::geom_line(ggplot2::aes(x = death_year,
                                    y = moving_average),
                       color = "blue") +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Total number of deaths due to hydro-geo and ext temp eventes by year")



# BY YEAR: HYDRO-GEO AND EXT TEMP CAUSES W/O 2011 TRAGEDY
# TODO: REVIEW TITTLE
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::group_by(death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::mutate(moving_average = RcppRoll::roll_mean(fatalities, 
                                                       n = 5, 
                                                       align = "right", 
                                                       fill = NA,
                                                       na.rm = TRUE))  %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities)) +
    ggplot2::geom_point() +
    ggplot2::geom_line(ggplot2::aes(x = death_year,
                                    y = moving_average),
                       color = "blue") +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Total number of deaths by hydro-geo and ext temp events by year w/o 2011 tragedy")

```



```{r plot_by_cause, echo=FALSE, fig.width = 7, fig.height = 5}

# W/O 2011 TRAGEDY
# LOGARITM
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::group_by(death_year, cause) %>%
    dplyr::summarize(fatalities = log(dplyr::n()),
                     .groups = "drop") %>%
    # NOTE: Util function for adding the roll means as a new column.
    (function(x) {
        my_data <- x %>%
            dplyr::arrange(death_year, cause) %>%
            tidyr::pivot_wider(id_cols = death_year,
                               names_from = cause,
                               values_from = fatalities)
        my_roll <- RcppRoll::roll_mean(as.matrix(dplyr::select(my_data, 
                                                               -death_year)),
                                       n = 5,
                                       align = "right",
                                       fill = NA,
                                       na.rm = TRUE) %>%
            tibble::as_tibble() %>%
            magrittr::set_names(paste(names(.), "roll_mean", sep = "_")) %>%
            dplyr::mutate(death_year = my_data$death_year) %>%
            tidyr::pivot_longer(!death_year) %>%
            dplyr::rename(moving_average = value)
        my_data %>%
            tidyr::pivot_longer(!death_year,
                                names_to = "cause",
                                values_to = "fatalities") %>%
            dplyr::bind_cols(dplyr::select(my_roll, moving_average)) %>%
            return()
    }) %>%
    dplyr::arrange(death_year) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities)) +
    ggplot2::geom_point() +
    ggplot2::geom_line(ggplot2::aes(x = death_year,
                                    y = moving_average),
                       color = "blue") +
    ggplot2::facet_wrap(~cause,
                        ncol = 3) +
    ggplot2::xlab("Year") +
    ggplot2::theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggplot2::ylab("Logarithm of the number of fatalities") +
    ggplot2::ggtitle("Number of deaths by hydro-geo and ext temp events w/o 2011 tragedy")

```



```{r plot_causes, echo=FALSE, fig.width = 7, fig.height = 5}

# DEATHS HIDRO-GEO CAUSES
hydrogeo_extemp_tb %>%
    dplyr::group_by(cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::arrange(cause, death_year) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earth surface and Eruption",
                               "Flood",
                               "Landslide",
                               "Earthquake")) %>%             
    dplyr::filter(!is.na(cause), !is.na(death_year)) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Death due to hydro-geological events") + 
    ggplot2::scale_color_brewer(palette = "Dark2")



# DEATHS HIDRO-GEO CAUSES: W/O SERRANA DISASTER
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::group_by(cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::arrange(cause, death_year) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earth surface and Eruption",
                               "Flood",
                               "Landslide",
                               "Earthquake")) %>%             
    dplyr::filter(!is.na(cause), !is.na(death_year)) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Death due to hydro-geological events w/o 2011 tragedy") + 
    ggplot2::scale_color_brewer(palette = "Dark2")



# DEATHs EXTREME TEMPERATURE CAUSE
hydrogeo_extemp_tb  %>%
    dplyr::group_by(cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::arrange(cause, death_year) %>%
    dplyr::filter(cause %in% c("Cold",
                               "Heat")) %>%             
    dplyr::filter(!is.na(cause), !is.na(death_year)) %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Death due to extreme temperature") + 
    ggplot2::scale_color_brewer(palette = "Set1")

```



```{r cause_state, echo=FALSE, fig.width = 10, fig.height = 7}

library(geobr)
library(sf)

# Download the data.
state_sf <- geobr::read_state(year = 2010, 
                              simplified = TRUE, 
                              showProgress = FALSE)
state_tb <- state_sf %>%
    sf::st_set_geometry(NULL) %>%
    tibble::as_tibble()

town_sf <- geobr::read_municipality(year = 2010, 
                                    simplified = TRUE,
                                    showProgress = FALSE)
town_tb <- town_sf %>%
    sf::st_set_geometry(NULL) %>%
    tibble::as_tibble() %>%
    dplyr::mutate(code_muni = as.character(code_muni)) %>%
    dplyr::left_join(state_tb, by = "abbrev_state")


# BY STATE HYDRO-GEO CAUSES
hydrogeo_extemp_tb %>%
    dplyr::left_join(town_tb, by = c("death_city" = "code_muni")) %>%
    dplyr::group_by(death_year, cause, abbrev_state) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earth surface and Eruption",
                               "Flood",
                               "Landslide",
                               "Earthquake")) %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities, 
                                 color = cause, 
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(vars(abbrev_state)) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Deaths due to hydro-geological events by state") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY STATE HYDRO-GEO CAUSES W/O SERRANA DISASTER
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::left_join(town_tb, by = c("death_city" = "code_muni")) %>%
    dplyr::group_by(death_year, cause, abbrev_state) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earth surface and Eruption",
                               "Flood",
                               "Landslide",
                               "Earthquake")) %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities, 
                                 color = cause, 
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(vars(abbrev_state)) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Deaths due to hydro-geological events by state w/o 2011 tragedy") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY STATE EXTREME TEMP CAUSES 
hydrogeo_extemp_tb %>%
    dplyr::left_join(town_tb, by = c("death_city" = "code_muni")) %>%
    dplyr::group_by(death_year, cause, abbrev_state) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(cause %in% c("Cold",
                               "Heat")) %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities, 
                                 color = cause, 
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(vars(abbrev_state)) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Deaths due to extreme temepratures by state") +
    ggplot2::scale_color_brewer(palette = "Set1")

```



```{r cause_region, echo=FALSE, fig.width = 10, fig.height = 7}

# BY REGION HYDRO-GEO (NE, S, N, SE, CO)
hydrogeo_extemp_tb %>%
    dplyr::left_join(town_tb, by = c("death_city" = "code_muni")) %>%
    dplyr::group_by(death_year, cause, name_region) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earth surface and Eruption",
                               "Flood",
                               "Landslide",
                               "Earthquake")) %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities, 
                                 color = cause, 
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(vars(name_region)) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Deaths due to hydro-geological events by region") + 
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY REGION HYDRO-GEO W/O SERRANA DISASTER
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::left_join(town_tb, by = c("death_city" = "code_muni")) %>%
    dplyr::group_by(death_year, cause, name_region) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earth surface and Eruption",
                               "Flood",
                               "Landslide",
                               "Earthquake")) %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities, 
                                 color = cause, 
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(vars(name_region)) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Deaths due to hydro-geological events by region w/o 2011 tragedy") + 
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY REGION EXTR TEMP (NE, S, N, SE, CO)
hydrogeo_extemp_tb %>%
    dplyr::left_join(town_tb, by = c("death_city" = "code_muni")) %>%
    dplyr::group_by(death_year, cause, name_region) %>%
    dplyr::summarize(fatalities = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(cause %in% c("Cold",
                               "Heat")) %>%
    tidyr::drop_na() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = fatalities, 
                                 color = cause, 
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(vars(name_region)) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Number of fatalities") +
    ggplot2::ggtitle("Deaths due to extreme temperatures by region") +
    ggplot2::scale_color_brewer(palette = "Set1")

```



## SOCIAL ANALYSIS
## TODO: RUN SOCIAL ANALISYS EXCLUSIVELY FOR data_10
## TODO: JOIN BARCHELOR W/ BARCHELOR INCOMPLETE



```{r plot_causes_sex_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

# BY SEX: HYDRO-GEOLOGICAL DISASTERS  
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::filter(sex %in% c("Male", "Female")) %>%
    dplyr::group_by(sex, cause, death_year) %>%
    dplyr::arrange(sex, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~sex) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by sex") +
    ggplot2::ggtitle("Cumulative sum of deaths due to hydro-geo events by sex") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY SEX: HYDRO-GEOLOGICAL DISASTERS W/O SERRANA DISASTER  
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>%
    dplyr::filter(sex %in% c("Male", "Female")) %>%
    dplyr::group_by(sex, cause, death_year) %>%
    dplyr::arrange(sex, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc", 
                               "Cataclismyc and Floods",
                               "Earthquake", 
                               "Earth surface and Eruption", 
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~sex) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of deaths due to hydro-geo events by sex") +
    ggplot2::ggtitle("Cumulative sum of deaths due to hydro-geo causes and sex w/o 2011 Serrana") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY SEX: EXTREME TEMPERATURES DISASTERS  
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::filter(sex %in% c("Male", "Female")) %>%
    dplyr::group_by(sex, cause, death_year) %>%
    dplyr::arrange(sex, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cold",
                               "Heat")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~sex) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by sex") +
    ggplot2::ggtitle("Cumulative sum of deaths due to hydro-geo events by sex") +
    ggplot2::scale_color_brewer(palette = "Set1")

```


```{r plot_causes_race_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

# BY RACE: HYDRO-GEOLOGICAL DISASTERS  
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::filter(color_race %in% c("White",
                                    "Black",
                                    "Yellow",
                                    "Mixed",
                                    "Indigenous")) %>%
    dplyr::group_by(color_race, cause, death_year) %>%
    dplyr::arrange(color_race, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~color_race) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by sex") +
    ggplot2::ggtitle("Cumulative sum of deaths due to hydro-geo events by race") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY RACE: HYDRO-GEOLOGICAL DISASTERS WITHOUT SERRANA DISASTER  
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::filter(color_race %in% c("White",
                                    "Black",
                                    "Yellow",
                                    "Mixed",
                                    "Indigenous")) %>%
    dplyr::group_by(color_race, cause, death_year) %>%
    dplyr::arrange(color_race, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~color_race) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by sex") +
    ggplot2::ggtitle("Cumulative sum of deaths due to hydro-geo events by race w/o 2011 tragedy") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY RACE: EXTREME TEMPERATURES EVENTS 
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::filter(color_race %in% c("White",
                                    "Black",
                                    "Yellow",
                                    "Mixed",
                                    "Indigenous")) %>%
    dplyr::group_by(color_race, cause, death_year) %>%
    dplyr::arrange(color_race, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cold",
                               "Heat")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~color_race) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by sex") +
    ggplot2::ggtitle("Cumulative sum of deaths due to hydro-geo events by race") +
    ggplot2::scale_color_brewer(palette = "Set1")



```



```{r plot_causes_esc_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

# BY EDUCATION: HYDRO-GEOLOGICAL DISASTERS 
# WARNING: DATA GAP FROM 1996 TO 2012
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::mutate(education = as.factor(education),
                  cause     = as.factor(cause)) %>%
    tidyr::drop_na(education) %>%
    dplyr::group_by(education, cause, death_year) %>%
    dplyr::arrange(education, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~education) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by education") +
    ggplot2::ggtitle("Cumulative sum of deaths by hydro-geo events and education") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY EDUCATION: HYDRO-GEOLOGICAL DISASTERS WITHOUT SERRANA DISASTER 
# WARNING: DATA GAP FROM 1996 TO 2012
hydrogeo_extemp_no_serrana_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::mutate(education = as.factor(education),
                  cause     = as.factor(cause)) %>%
    tidyr::drop_na(education) %>%
    dplyr::group_by(education, cause, death_year) %>%
    dplyr::arrange(education, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~education) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by education") +
    ggplot2::ggtitle("Cumulative sum of deaths by hydro-geo events and education") +
    ggplot2::scale_color_brewer(palette = "Dark2")



# BY EDUCATION: EXTREME TEMPERATURES EVENTS 
# WARNING: DATA GAP FROM 1996 TO 2012
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::mutate(education = as.factor(education),
                  cause     = as.factor(cause)) %>%
    tidyr::drop_na(education) %>%
    dplyr::group_by(education, cause, death_year) %>%
    dplyr::arrange(education, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cold",
                               "Heat")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~education) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by education") +
    ggplot2::ggtitle("Cumulative sum of deaths by hydro-geo events and education") +
    ggplot2::scale_color_brewer(palette = "Set1")


```



```{r plot_causes_literacy_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

# BY LITERACY: HYDRO-GEOLOGICAL DISASTERS 
hydrogeo_extemp_tb %>%
    dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::mutate(literacy = as.factor(literacy),
                  cause     = as.factor(cause)) %>%
    tidyr::drop_na(literacy) %>%
    dplyr::group_by(literacy, cause, death_year) %>%
    dplyr::arrange(literacy, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~literacy) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by literacy") +
    ggplot2::ggtitle("Cumulative sum of deaths by hydro-geo events and literacy") +
    ggplot2::scale_color_brewer(palette = "Dark2")


# BY LITERACY: HYDRO-GEOLOGICAL DISASTERS WITHOUT SERRANA DISASTER 
hydrogeo_extemp_no_serrana_tb %>%
     dplyr::filter(death_date >= lubridate::as_date("1996-01-01")) %>% 
    dplyr::mutate(literacy = as.factor(literacy),
                  cause     = as.factor(cause)) %>%
    tidyr::drop_na(literacy) %>%
    dplyr::group_by(literacy, cause, death_year) %>%
    dplyr::arrange(literacy, cause, death_year) %>%
    dplyr::summarize(fatalities = dplyr::n()) %>%
    dplyr::filter(cause %in% c("Cataclismyc",
                               "Cataclismyc and Floods",
                               "Earthquake",
                               "Earth surface and Eruption",
                               "Landslide",
                               "Flood")) %>%
    dplyr::mutate(cumsum = cumsum(fatalities)) %>%
    dplyr::ungroup() %>%
    ggplot2::ggplot(ggplot2::aes(x = death_year,
                                 y = cumsum,
                                 color = cause,
                                 group = cause)) +
    ggplot2::geom_point() +
    ggplot2::geom_line() +
    ggplot2::facet_wrap(~literacy) +
    ggplot2::xlab("Year") +
    ggplot2::ylab("Cumulative number of fatalities by literacy") +
    ggplot2::ggtitle("Cumulative sum of deaths by hydro-geo events and literacy w/o 2011 tragedy") +
    ggplot2::scale_color_brewer(palette = "Dark2")








# TODO: INCLUDE ANALISYS FOR LITERACY AND MARITAL


