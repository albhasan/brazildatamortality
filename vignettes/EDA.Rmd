---
title: "Exploratory data analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EDA}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}

library(dplyr)
library(ggplot2)
library(knitr)
library(lubridate)
library(magrittr)
library(RcppRoll)
library(read.dbc)
library(skimr)
library(stringr)
library(tidyr)

library(brazildatamortality)

data_tb <- brazildatamortality::data_icd_10

causabas_tb <- tibble::tribble(
  #~Cause, ~Description,
  ~code_cause, ~Cause,
  #"X30-X39", "Natural forces", #"Exposição às forças da natureza",
  "X30",     "Heat",           #"Exposição a calor natural excessivo",
  "X31",     "Cold",           #"Exposição a frio natural excessivo",
  "X32",     "Sunlight",       #"Exposição à luz solar",
  "X33",     "Lightning",      #"Vítima de raio",
  "X34",     "Earthquake",     #"Vítima de terremoto",
  "X35",     "Volcano",        #"Vítima de erupção vulcânica",
  "X36",     "Landslide",      #"Vítima de avalanche, desabamento de terra e outros movimentos da superfície terrestre",
  "X37",     "Tempest",        #"Vítima de tempestade cataclísmica",
  "X38",     "Flood",          #, "Vítima de inundação",
  "X39",     "Other",          #"Exposição a outras forças da natureza e às não especificadas"
)

sexo_tb <- tibble::tribble(
  ~code_sex, ~Sexo, 
  "0",      "No information",
  "1",      "Male",
  "2",      "Female",
  "9",      "TODO"
)

esc_tb <- tibble::tribble(
  ~code_esc, ~Education,
  "0", "Sem escolaridade",
  "1", "Fundamental I", # (1ª a 4ª série)",
  "2", "Fundamental II", # (5ª a 8ª série)",
  "3", "Médio", # (antigo 2º Grau)",
  "4", "Superior incompleto",
  "5", "Superior completo",
  "9", "Ignorado"
)

plot_data <- data_tb %>%
  dplyr::select(CAUSABAS, SEXO, ESC, date) %>%
  dplyr::mutate(death_year = lubridate::year(date),
                code_cause = stringr::str_sub(CAUSABAS, 1, 3)) %>%
  dplyr::left_join(causabas_tb, by = "code_cause") %>%
  dplyr::left_join(sexo_tb, by = c("SEXO" = "code_sex")) %>%
  dplyr::left_join(esc_tb,  by = c("ESC" = "code_esc"))

```

## Abstract.

This is the Exploratory Data Analysis.


## Introduction.

## Materials and methods.

## Results.

```{r plot_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

plot_data %>%
  dplyr::group_by(death_year) %>%
  dplyr::summarize(fatalities = dplyr::n(), 
                   .groups = "drop") %>%
  dplyr::mutate(cumsum = cumsum(fatalities)) %>%
  dplyr::arrange(death_year) %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = cumsum)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Accumulated number of fatalities") +
  ggplot2::ggtitle("Accumulated number of deaths by natural disasters")

```


```{r plot_total, echo=FALSE, fig.width = 7, fig.height = 5}

plot_data %>%
  dplyr::group_by(death_year) %>%
  dplyr::summarize(fatalities = dplyr::n(), 
                   .groups = "drop") %>%
  dplyr::mutate(moving_average = RcppRoll::roll_mean(fatalities, 
                                                     n = 5, 
                                                     align = "right", 
                                                     fill = NA,
                                                     na.rm = TRUE))  %>%
  dplyr::arrange(death_year) %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = fatalities)) +
  ggplot2::geom_point() +
  ggplot2::geom_line(ggplot2::aes(x = death_year,
                                  y = moving_average),
                                  color = "blue") +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Number of fatalities") +
  ggplot2::ggtitle("Total number of deaths by natural disasters")

```


```{r plot_causes, echo=FALSE, fig.width = 7, fig.height = 5}

plot_data %>%
  dplyr::group_by(Cause, death_year) %>%
  dplyr::summarize(fatalities = dplyr::n(), 
                   .groups = "drop") %>%
  dplyr::arrange(Cause, death_year) %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = fatalities,
                               color = Cause,
                               group = Cause)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Number of fatalities") +
  ggplot2::ggtitle("Death by cause")

```

```{r plot_causes_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

plot_data %>%
  dplyr::group_by(Cause, death_year) %>%
  dplyr::summarize(fatalities = dplyr::n()) %>%
  dplyr::mutate(cumsum = cumsum(fatalities)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(Cause, death_year) %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = cumsum,
                               color = Cause,
                               group = Cause)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Cumulative number of fatalities") +
  ggplot2::ggtitle("Cumulative sum of deaths by cause")

```


```{r plot_causes_sex_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

data_tb %>%
  dplyr::mutate(death_year = lubridate::year(date),
                code_cause = stringr::str_sub(CAUSABAS, 1, 3)) %>%
  dplyr::left_join(causabas_tb, by = "code_cause") %>%
  dplyr::left_join(sexo_tb, by = c("SEXO" = "code_sex")) %>%
  dplyr::filter(Sexo %in% c("Male", "Female")) %>%
  dplyr::group_by(Sexo, Cause, death_year) %>%
  dplyr::arrange(Sexo, Cause, death_year) %>%
  dplyr::summarize(fatalities = dplyr::n()) %>%
  dplyr::mutate(cumsum = cumsum(fatalities)) %>%
  dplyr::ungroup() %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = cumsum,
                               color = Cause,
                               group = Cause)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~Sexo) +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Cumulative number of fatalities by sex") +
  ggplot2::ggtitle("Cumulative sum of deaths by cause and sex")

```


```{r plot_causes_esc_cumsum, echo=FALSE, fig.width = 7, fig.height = 5}

plot_data %>%
  dplyr::mutate(Education = as.factor(Education),
                Cause     = as.factor(Cause)) %>%
  dplyr::group_by(Education, Cause, death_year) %>%
  dplyr::arrange(Education, Cause, death_year) %>%
  dplyr::summarize(fatalities = dplyr::n()) %>%
  dplyr::mutate(cumsum = cumsum(fatalities)) %>%
  dplyr::ungroup() %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = cumsum,
                               color = Cause,
                               group = Cause)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  #ggplot2::scale_color_brewer(palette = "Spectral") + 
  #ggplot2::scale_colour_viridis_d(option = "plasma") +
  ggplot2::facet_wrap(~Education) +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Cumulative number of fatalities by education") +
  ggplot2::ggtitle("Cumulative sum of deaths by cause and education")

```








```{r plot_by_cause, echo=FALSE, fig.width = 7, fig.height = 5}

plot_data %>%
  dplyr::group_by(death_year, Cause) %>%
  dplyr::summarize(fatalities = log(dplyr::n()),
                   .groups = "drop") %>%
  # NOTE: Util function for adding the roll means as a new column.
  (function(x) {
    my_data <- x %>%
      dplyr::arrange(death_year, Cause) %>%
      tidyr::pivot_wider(id_cols = death_year,
                         names_from = Cause,
                         values_from = fatalities)
    my_roll <- RcppRoll::roll_mean(as.matrix(dplyr::select(my_data, 
                                                           -death_year)),
                                   n = 5,
                                   align = "right",
                                   fill = NA,
                                   na.rm = TRUE) %>%
      tibble::as_tibble() %>%
      magrittr::set_names(paste(names(.), "roll_mean", sep = "_")) %>%
      dplyr::mutate(death_year = my_data$death_year) %>%
      tidyr::pivot_longer(!death_year) %>%
      dplyr::rename(moving_average = value)
   my_data %>%
     tidyr::pivot_longer(!death_year,
                         names_to = "Cause",
                         values_to = "fatalities") %>%
     dplyr::bind_cols(dplyr::select(my_roll, moving_average)) %>%
     return()
  }) %>%
  dplyr::arrange(death_year) %>%
  ggplot2::ggplot(ggplot2::aes(x = death_year,
                               y = fatalities)) +
  ggplot2::geom_point() +
  ggplot2::geom_line(ggplot2::aes(x = death_year,
                                  y = moving_average),
                                  color = "blue") +
  ggplot2::facet_wrap(~Cause,
                      ncol = 3) +
  ggplot2::xlab("Year") +
  ggplot2::theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggplot2::ylab("Logarithm of the number of fatalities") +
  ggplot2::ggtitle("Number of deaths by natural disasters by cause")

```



## Conclusions.

## References.
